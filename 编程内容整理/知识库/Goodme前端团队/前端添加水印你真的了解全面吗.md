![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn4qZSmT3UicN7zQTxPWND9guwvMaL34zoVJu4f3NVB9bGIlW7OetJEfVg/0?wx_fmt=jpeg)

#  ã€Œå‰ç«¯æ·»åŠ æ°´å°ã€ä½ çœŸçš„äº†è§£å…¨é¢å—ï¼Ÿ

åŸåˆ›  Susu  [ Goodmeå‰ç«¯å›¢é˜Ÿ ](javascript:void\(0\);)

__ _ _ _ _

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn4iciaa1a3YTfK7lmYgArC8EIp4dGlHNwDP6X92cxSuknoz7N21TcbvCzg/640?wx_fmt=png&from=appmsg)

##  èƒŒæ™¯

åœ¨å¤èŒ—æ—¥å¸¸ä¸šåŠ¡ä¸­ï¼Œç»å¸¸ä¼šç»™åŠ ç›Ÿå•†ä¸‹å‘å„ç§èµ„æ–™ï¼Œä¾‹å¦‚ï¼šå¥¶èŒ¶çš„é…æ–¹ã€è®¾å¤‡çš„æ¸…æ´—ã€å«ç”Ÿçš„æ ‡å‡†ç­‰ç­‰ç­‰ã€‚è¿™äº›èµ„æ–™éƒ½æ˜¯ä¸€äº›å†…éƒ¨èµ„æ–™ï¼Œä»ä¿¡æ¯å®‰å…¨ç»´åº¦ä¸èƒ½è¢«æ³„éœ²å’Œç›—å–å‡ºå»ã€‚æ‰€ä»¥ä¼šç»™ä¸‹å‘çš„èµ„æ–™åŠ ä¸Šæ°´å°ã€‚è¿™äº›èµ„æ–™å¯èƒ½æ˜¯çº¯æ–‡æœ¬ï¼Œä¹Ÿå¯èƒ½æ˜¯æ–‡æœ¬åŠ å›¾ç‰‡çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¦åšå¥½ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š

  * é€šè¿‡å¯¹é¡µé¢å¢åŠ æ°´å°ï¼Œå¯ä»¥ä»ç³»ç»Ÿçº§åˆ«é˜²æ­¢åˆ«äººç›—å–æˆ‘ä»¬çš„é¡µé¢ä¿¡æ¯ 
  * é€šè¿‡å¯¹å•ç‹¬çš„å›¾ç‰‡åŠ æ°´å° - é˜²æ­¢å›¾ç‰‡ä¿å­˜æ—¶æ²¡æœ‰æ°´å° 

##  é¡µé¢æ°´å°

###  æ–¹æ¡ˆè®¾è®¡

å®ç°é¡µé¢æ°´å°çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¯ä»¥çœ‹ä¸€äº›å¸¸ç”¨é¡µé¢åŠ æ°´å°çš„æ–¹æ¡ˆï¼Œå…·ä½“å¦‚ä¸‹ï¼š

  * æ–¹æ¡ˆä¸€ï¼šfixed å®šä½çš„ div å…ƒç´ ï¼Œé‡å¤æ¸²æŸ“ div å…ƒç´ æ¥æ·»åŠ æ°´å°ã€‚ä¼šåˆ›å»ºå¾ˆå¤šæ— å…³çš„ DOM å…ƒç´  
  * æ–¹æ¡ˆäºŒï¼šfixed å®šä½ canvas å…ƒç´ ï¼Œé‡å¤å¡«å……æ°´å°ã€‚å§‹ç»ˆä¼šåˆ›å»ºä¸€ä¸ªæ— å…³çš„ canvas å…ƒç´  
  * æ–¹æ¡ˆä¸‰ï¼šcanvas + ä¼ªç±»ã€‚ä¸ä¼šåˆ›å»ºæ— å…³å…ƒç´ ï¼Œä¸”å…¼å®¹æ€§å¥½ 
  * æ–¹æ¡ˆå››ï¼šsvg + ä¼ªç±»ã€‚ä¸ä¼šåˆ›å»ºæ— å…³å…ƒç´ ï¼Œä½†å…¼å®¹æ€§ç•¥å·®äº canvas 

è¿™äº›æ–¹æ¡ˆï¼Œéƒ½æœ‰ä¸€ä¸ªé€šç”¨çš„ç¼ºç‚¹ï¼Œé‚£å°±æ˜¯å°†å…ƒç´ åˆ æ‰ï¼Œæˆ–è€…å°†ç±»ååˆ æ‰ï¼Œéƒ½èƒ½å»é™¤é¡µé¢æ°´å°ã€‚

åŸºäºå®ç°æˆæœ¬å’Œå®‰å…¨æ€§ç»´åº¦çš„è€ƒè™‘ï¼Œ **æœ€ç»ˆæ–¹æ¡ˆé€‰å‹ï¼šæ–¹æ¡ˆä¸‰** ï¼ŒåŒæ—¶å¢åŠ äº†é€šè¿‡MutationObserver - Web API æ¥å£å‚è€ƒ | MDN è§£å†³äº†åˆ é™¤ç±»åå¯¼è‡´æ°´å°åˆ é™¤çš„é—®é¢˜ã€‚ 

æ ¸å¿ƒåŠŸèƒ½ç‚¹ï¼š

  * æŠŠç­¾åä¿¡æ¯ï¼Œé€šè¿‡ Canvas ç”ŸæˆèƒŒæ™¯å›¾ 
  * åˆ©ç”¨ä¼ªç±»å°†èƒŒæ™¯å›¾æ·»åŠ åˆ°éœ€è¦ç”Ÿæˆæ°´å°çš„åŒºåŸŸä¸Š 
  * é€šè¿‡ MutationObserver , è§£å†³äº†åˆ é™¤ç±»åå¯¼è‡´æ°´å°åˆ é™¤çš„é—®é¢˜ 

###  ä»£ç å®ç°

####  æŠŠç­¾åä¿¡æ¯ï¼Œé€šè¿‡Canvasç”ŸæˆèƒŒæ™¯å›¾

  * åˆ©ç”¨ Canvas æ¥ç»˜åˆ¶èƒŒæ™¯å›¾ï¼ŒèƒŒæ™¯å†…å®¹ä¸ºæ°´å°çš„å†…å®¹ 
  * é€šè¿‡ toDataURL å°† Canvas è½¬æ¢æˆå›¾ç‰‡ï¼Œæ ¼å¼ä¸º image/png 

    
    
    interfaceÂ IImgOptionsÂ {  
    Â Â content:Â string[];Â //Â æ°´å°çš„å†…å®¹ï¼Œå¯ä¼ é€’å¤šä¸ªæ°´å°  
    Â Â canvasHeight:Â number;Â //Â ç”»å¸ƒçš„é«˜åº¦  
    Â Â canvasWidth:Â number;Â //Â ç”»å¸ƒçš„å®½åº¦  
    }  
    constÂ createImgBaseÂ =Â (options:Â IImgOptions)Â =>Â {  
    Â Â constÂ {Â content,Â canvasHeight,Â canvasWidthÂ }Â =Â options;  
    Â Â constÂ canvasÂ =Â document.createElement('canvas');Â //Â åˆ›å»ºä¸€ä¸ªç”»å¸ƒ  
    Â Â constÂ ctxÂ =Â canvas.getContext('2d');  
    Â Â //Â è®¾ç½®ç”»å¸ƒçš„å®½é«˜  
    Â Â canvas.widthÂ =Â canvasHeight;  
    Â Â canvas.heightÂ =Â canvasWidth;  
    Â Â ifÂ (ctx)Â {  
    Â Â Â Â ctx.rotate((-10Â *Â Math.PI)Â /Â 180);Â //Â åç§»ä¸€ç‚¹è·ç¦»  
    Â Â Â Â ctx.fillStyleÂ =Â 'rgba(100,100,100,0.2)';Â //Â è®¾ç½®ç»˜åˆ¶çš„é¢œè‰²  
    Â Â Â Â ctx.fontÂ =Â '40px';Â //Â è®¾ç½®å­—ä½“çš„å¤§å°  
    Â Â Â Â //Â éå†æ°´å°å†…å®¹  
    Â Â Â Â content.forEach((text,Â index)Â =>Â {  
    Â Â Â Â Â Â ctx.fillText(text,Â 10,Â 30Â *Â (indexÂ +Â 1));Â //Â æ‹‰å¼€30çš„é—´è·  
    Â Â Â Â });  
    Â Â }  
    Â Â returnÂ canvas.toDataURL('image/png');Â //Â è½¬æ¢ç¨‹dataÂ urlï¼Œå¯ä¾›imgç›´æ¥ä½¿ç”¨  
    };  
    

####  åˆ©ç”¨ä¼ªç±»å°†èƒŒæ™¯å›¾æ·»åŠ åˆ°æ•´ä¸ªé¡µé¢ä¸Š

  * ç»™éœ€è¦æ·»åŠ æ°´å°å…ƒç´ æ·»åŠ ä¸€ä¸ªå¯¹åº”çš„ä¼ªå…ƒç´ ï¼Œå°†ç¬¬ä¸€æ­¥é€šè¿‡ Canvas ç”Ÿæˆçš„ data url ä½œä¸ºèƒŒæ™¯ 
  * åˆ›å»ºä¸€ä¸ª style å…ƒç´ ï¼Œå°†ä¼ªå…ƒç´ æ”¾åœ¨ style.innerHTML ä¸­ï¼Œç„¶å appendChild åˆ° head ä¸­ï¼Œæ­¤æ—¶ï¼Œé¡µé¢æ°´å°å°±åŠ å®Œäº† 

    
    
    constÂ genWaterMarkÂ =Â ({  
    Â Â content,  
    Â Â className,  
    Â Â canvasHeightÂ =Â 140,  
    Â Â canvasWidthÂ =Â 150,  
    })Â =>Â {  
    Â Â constÂ dataURLÂ =Â createImgBase({Â content,Â canvasHeight,Â canvasWidthÂ });  
    Â Â constÂ defaultStyleÂ =Â document.createElement('style');  
    Â Â defaultStyle.innerHTMLÂ =Â `.${className}::afterÂ {  
    Â Â Â Â content:Â '';  
    Â Â Â Â display:Â block;  
    Â Â Â Â width:Â 100%;  
    Â Â Â Â height:Â 100vh;  
    Â Â Â Â background-image:Â url(${dataURL});  
    Â Â Â Â background-repeat:Â repeat;  
    Â Â Â Â pointer-events:Â none;  
    Â Â Â Â position:Â fixed;  
    Â Â Â Â top:Â 0;  
    Â Â Â Â left:Â 0;  
    Â Â }`;  
    Â Â document.head.appendChild(defaultStyle);  
    };  
      
      
    //Â ä½¿ç”¨æ–¹å¼  
    constÂ ContentÂ =Â ()Â =>Â {  
    Â Â Â Â useEffect(()Â =>Â {  
    Â Â Â Â genWaterMark({  
    Â Â Â Â Â Â content:Â [userName,Â userPhone,Â 'å†…éƒ¨æœºå¯†ææ–™',Â 'ä¸¥ç¦å¤–æ³„ï¼'],  
    Â Â Â Â Â Â className:Â 'my-page-container',  
    Â Â Â Â });  
    Â Â },Â []);  
    Â Â returnÂ (  
    Â Â Â Â <divÂ className="my-page-container"Â id="my-page-container">  
    Â Â Â Â Â Â <divÂ className="my-info">  
    Â Â Â Â Â Â Â Â <divÂ className="title">è¿™æ˜¯æµ‹è¯•æ ‡é¢˜</div>  
    Â Â Â Â Â Â Â Â <divÂ className="content">  
    Â Â Â Â Â Â Â Â Â Â //Â ...æˆ‘æƒ³è¿™æ˜¯æœºå¯†å†…å®¹Â *Â n  
    Â Â Â Â Â Â Â Â </div>  
    Â Â Â Â Â Â </div>  
    Â Â Â Â </div>  
    Â Â )  
    }  
      
    //Â cssæ ·å¼  
    .my-page-containerÂ {  
    Â Â height:Â calc(100vhÂ -Â 104px);  
    Â Â overflow:Â hidden;  
      
    Â Â .my-infoÂ {  
    Â Â Â Â display:Â flex;  
    Â Â Â Â flex:Â 1;  
    Â Â Â Â flex-direction:Â column;  
    Â Â Â Â height:Â 100%;  
    Â Â Â Â padding:Â 24px;  
    Â Â Â Â overflow-y:Â auto;  
      
    Â Â Â Â //Â .titleÂ &Â .contentÂ ä¸€äº›ä¸é‡è¦çš„css  
    Â Â }  
    

é¡µé¢æ•ˆæœå¦‚ä¸‹ï¼šè„±æ•å¤„ç†ï¼Œæˆªå›¾æœªå±•ç¤ºå§“åå’Œæ‰‹æœºå·ã€‚

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn4Tm2lBnQ4EoXNv9e57yHe7oZALYIezLZoJvC4htsb5rzWWGYYdF7DiaQ/640?wx_fmt=png&from=appmsg)

####  åˆ©ç”¨MutationObserverï¼Œé˜²æ­¢è¢«äººåˆ é™¤className

    
    
    constÂ listenerDOMChangeÂ =Â (className:Â string)Â =>Â {  
    Â Â constÂ targetNodeÂ =Â document.querySelector(`.${className}`);  
    Â Â constÂ observerÂ =Â newÂ MutationObserver((mutationsList)Â =>Â {  
    Â Â Â Â forÂ (letÂ mutationÂ ofÂ mutationsList)Â {  
    Â Â Â Â Â Â ifÂ (mutation.typeÂ ===Â 'attributes'Â &&Â mutation.attributeNameÂ ===Â 'class'Â &&Â targetNode)Â {Â //Â ç›‘å¬å±æ€§å¹¶ä¸”å±æ€§åä¸ºclassçš„å˜æ›´  
    Â Â Â Â Â Â Â Â constÂ curClassValÂ =Â targetNode.getAttribute('class')Â ||Â '';  
    Â Â Â Â Â Â Â Â ifÂ (curClassVal.indexOf(className)Â ===Â -1)Â {Â //Â ç›‘å¬åˆ°classNameè¢«åˆ é™¤äº†ï¼Œæ‰‹åŠ¨åŠ å›å»  
    Â Â Â Â Â Â Â Â Â Â targetNode.setAttribute('class',Â `${className}Â ${curClassVal}`);  
    Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â }  
    Â Â Â Â }  
    Â Â });  
      
    Â Â observer.observe(targetNodeÂ asÂ Node,Â {  
    Â Â Â Â attributes:Â true,  
    Â Â });  
    };  
    constÂ genWaterMarkÂ =Â ({  
    Â Â content,  
    Â Â className,  
    Â Â canvasHeightÂ =Â 140,  
    Â Â canvasWidthÂ =Â 150,  
    }:Â IWaterMark)Â =>Â {  
    Â Â //Â ç›‘å¬classçš„å˜æ›´  
    Â Â listenerDOMChange(className);  
    Â Â constÂ dataURLÂ =Â createImgBase({Â content,Â canvasHeight,Â canvasWidthÂ });  
    Â Â constÂ defaultStyleÂ =Â document.createElement('style');  
    Â Â //Â çœç•¥  
    Â Â document.head.appendChild(defaultStyle);  
    };  
    

####  æ³¨æ„ç‚¹

æ³¨æ„ç‚¹â‘ ï¼š

  * **é—®é¢˜ï¼š**

ä¸Šè¿°æ–¹æ¡ˆçš„æ°´å°æ˜¯å æ®æ•´ä¸ªé¡µé¢çš„ï¼Œä½†æœ‰äº›æ°´å°æœŸæœ›æ˜¯åœ¨ç‰¹å®šåŒºåŸŸçš„ã€‚

  * **è§£å†³æ–¹æ¡ˆï¼š**

åˆ©ç”¨å®šä½ï¼Œå®ç°åœ¨ç‰¹å®šåŒºåŸŸå¢åŠ æ°´å°

    
    
    //Â é€šè¿‡è®¾ç½®position:Â absoluteæ¥å®ç°  
    constÂ genWaterMarkÂ =Â ({  
    Â Â content,  
    Â Â className,  
    Â Â canvasHeightÂ =Â 140,  
    Â Â canvasWidthÂ =Â 150,  
    }:Â IWaterMark)Â =>Â {  
    Â Â constÂ dataURLÂ =Â createImgBase({Â content,Â canvasHeight,Â canvasWidthÂ });  
    Â Â constÂ defaultStyleÂ =Â document.createElement('style');  
    Â Â defaultStyle.innerHTMLÂ =Â `.${className}::afterÂ {  
    Â Â Â Â content:Â '';  
    Â Â Â Â display:Â block;  
    Â Â Â Â position:Â absolute;  
    Â Â Â Â top:Â 0;  
    Â Â Â Â left:Â 0;  
    Â Â Â Â height:Â 100%;  
    Â Â Â Â width:Â 100%;  
    Â Â Â Â background-image:Â url(${dataURL});  
    Â Â Â Â background-repeat:Â repeat;  
    Â Â Â Â pointer-events:Â none;  
    Â Â }`;  
    Â Â document.head.appendChild(defaultStyle);  
    };  
      
    //Â ä½¿ç”¨æ–¹å¼  
    constÂ ContentÂ =Â ()Â =>Â {  
    Â Â useEffect(()Â =>Â {  
    Â Â Â Â genWaterMark({  
    Â Â Â Â Â Â content:Â [userName,Â userPhone,Â 'å†…éƒ¨æœºå¯†ææ–™',Â 'ä¸¥ç¦å¤–æ³„ï¼'],  
    Â Â Â Â Â Â className:Â 'wait-task-wrap',  
    Â Â Â Â });  
    Â Â },Â []);  
    Â Â returnÂ (  
    Â Â Â Â <ViewÂ className="my-page-container"Â id="my-page-container">  
    Â Â Â Â Â Â //Â ...ä¸€äº›ä¸é‡è¦çš„ä»£ç   
    Â Â Â Â Â Â <ViewÂ className="wait-task-wrap"></View>  
    Â Â Â Â </View>  
    Â Â )  
    }  
      
    //Â cssæ ·å¼  
    .wait-task-wrapÂ {  
    Â Â //Â ä¸€äº›ä¸é‡è¦çš„æ ·å¼  
    Â Â position:Â relative;  
    }  
    

é¡µé¢æ•ˆæœå¦‚ä¸‹ï¼š

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn4G6mwmyocW9rBjetD2gCX2KTothUQdUW5g1xYMYnkpD4ve3pM7IROKw/640?wx_fmt=png&from=appmsg)

###  3ã€å›¾ç‰‡æ°´å°

####  3.1 æ–¹æ¡ˆè®¾è®¡

åœ¨èµ„æ–™ä¸­ï¼Œå­˜åœ¨å¾ˆå¤šå›¾ç‰‡ï¼Œä½†é¡µé¢æ°´å°ï¼Œå¯¹å›¾ç‰‡ä½ æ¥è¯´å°±æˆ‘ä»¬è¦å¯¹å›¾ç‰‡è¿›è¡Œé¢„è§ˆå¹¶ä¸”æ”¯æŒä¿å­˜ã€‚æ­¤æ—¶é¡µé¢èƒŒæ™¯æ°´å°å°±æ²¡æœ‰ç”¨å•¦ï¼Œæˆ‘ä»¬ä¸‹è½½ä¸‹æ¥çš„å›¾ç‰‡è¿˜æ˜¯ä¸å¸¦æ°´å°çš„ã€‚é’ˆå¯¹è¿™ç§ç°è±¡ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸€äº›å¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆ

  * æ–¹æ¡ˆä¸€ï¼šæœåŠ¡ç«¯æ·»åŠ æ°´å°ï¼Œå®‰å…¨ï¼Œä½†æ˜¯æœåŠ¡ç«¯å‹åŠ›å¤§ä¸”æ€§èƒ½æ…¢ 
  * æ–¹æ¡ˆäºŒï¼šå€ŸåŠ© oss æ·»åŠ æ°´å°ï¼Œç®€ä¾¿ä½†æ˜¯ä¸é€šç”¨ 
  * æ–¹æ¡ˆä¸‰ï¼šcanvas æ–¹æ¡ˆï¼Œå®‰å…¨ä½†æ€§èƒ½æ…¢ 

æœ¬æ–‡ç€é‡ä»‹ç»åä¸¤ç§å‰ç«¯æ·»åŠ æ°´å°çš„æ–¹å¼ã€‚

###  ä»£ç å®ç°

####  å€ŸåŠ©oss

#####  å°†ossåœ°å€è½¬æˆå¸¦æ°´å°çš„ossåœ°å€

    
    
    //Â ossæ°´å°ä¸­çš„æ–‡å­—è¿›è¡Œurlå®‰å…¨çš„base64ç¼–ç   
    constÂ getSafeBase64CodeÂ =Â (name:Â string)Â =>Â {  
    Â Â returnÂ window  
    Â Â Â Â .btoa(unescape(encodeURIComponent(name)))  
    Â Â Â Â .replace(/+/g,Â '-')  
    Â Â Â Â .replace(//+/g,Â '_');  
    };  
      
    constÂ genOSSImageWaterMarkÂ =Â (imgSrc:Â string)Â =>Â {  
    Â Â constÂ {Â userName,Â userPhoneÂ }Â =Â JSON.parse(window.localStorage.getItem('userInfo')Â ||Â '{}');  
      
    Â Â returnÂ `${imgSrc}?x-oss-process=image/watermark,text_${getSafeBase64Code(  
    Â Â Â Â `${userName}-${userPhone}`  
    Â Â )},rotate_325,t_10,color_000000,size_30,fill_1,g_nw,x_30,y_30`;  
    };  
      
    //Â ä½¿ç”¨  
    constÂ ImageWaterMarkÂ =Â ()Â =>Â {  
    Â Â returnÂ (  
    Â Â Â Â <Image  
    Â Â Â Â Â Â src={genOSSImageWaterMark('xxxå›¾ç‰‡åœ°å€xxx')}  
    Â Â Â Â />  
    Â Â )  
    }  
    

é¡µé¢æ•ˆæœå¦‚ä¸‹ï¼š

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn4svZlPicdCgzYsGicl3hUV2rB4YHkL3DOldpRMCK9uanc6ncTlYTibCRnQ/640?wx_fmt=png&from=appmsg)
![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn4jW7BPHKjrB4FlY5iadw0Q20sFOsDtLoKMFabkDMb0Aa5q0ekLQqeMAQ/640?wx_fmt=png&from=appmsg)

#####  æ³¨æ„ç‚¹

æ³¨æ„ç‚¹â‘ 

  * **é—®é¢˜ï¼šæœ‰äº›å›¾ç‰‡æŸäº›åŒºåŸŸæ˜¯é€æ˜çš„ï¼Œå¯¼è‡´é€æ˜çš„åŒºåŸŸä¸Šä¸äº†è‰²ã€‚ï¼ˆæ•ˆæœå¦‚å›¾ä¸€ï¼‰**
  * è§£å†³æ–¹æ¡ˆï¼šui å‘Šè¯‰æˆ‘ä»¬ï¼Œpng å›¾ç‰‡å¯¼å‡ºé»˜è®¤æ˜¯é€æ˜çš„ï¼Œä½†æ˜¯ jpg é»˜è®¤ä¼šå°†é€æ˜çš„åœ°æ–¹å¡«å……ç™½è‰²çš„èƒŒæ™¯ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬æŸ¥é˜…å¯¹å›¾ç‰‡è¿›è¡Œæ ¼å¼è½¬æ¢çš„å‚æ•°è¯´æ˜åŠå®ä¾‹_å¯¹è±¡å­˜å‚¨-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒæ–‡æ¡£å¾—å‡ºï¼Œåªéœ€è¦åŠ ä¸Š x-oss-process=image/format,jpg, å¯¹ä¹‹å‰çš„ genOSSImageWaterMark è¿›è¡Œæ”¹é€ ï¼Œå¯¹é jpg çš„å›¾ç‰‡éƒ½è½¬æˆ jpg çš„å›¾ç‰‡ 

    
    
    constÂ genOSSImageWaterMarkÂ =Â (imgSrc:Â string)Â =>Â {  
    Â Â constÂ imgTypeÂ =Â imgSrc.split('.').slice(-1)[0];  
    Â Â constÂ {Â userName,Â userPhoneÂ }Â =Â JSON.parse(window.localStorage.getItem('userInfo')Â ||Â '{}');  
      
    Â Â returnÂ `${imgSrc}?${  
    Â Â Â Â imgTypeÂ !==Â 'jpg'Â ?Â 'x-oss-process=image/format,jpg,'Â :Â ''  
    Â Â }x-oss-process=image/watermark,text_${getSafeBase64Code(  
    Â Â Â Â `${userName}-${userPhone}`  
    Â Â )},rotate_325,t_10,color_000000,size_30,fill_1,g_nw,x_30,y_30`;  
    };  
    

æ•ˆæœå¦‚ä¸‹ï¼š

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn46gmMBnyy4yF5q5QDTuiakAOvV21qDpxpZiboMria4W19BrcveH1zZG2fA/640?wx_fmt=png&from=appmsg)

æ³¨æ„ç‚¹â‘¡

  * **é—®é¢˜ï¼šå­—ä½“å†™æ­»ï¼Œå¯¼è‡´æ°´å°åœ¨å¤§å›¾ä¸Šç‰¹åˆ«å°ï¼Œå°å›¾ä¸Šç‰¹åˆ«å¤§ã€‚ï¼ˆæ•ˆæœå¦‚å›¾äºŒï¼‰**
  * è§£å†³æ–¹æ¡ˆï¼šæ ¹æ®å›¾ç‰‡æ¯”ï¼Œè®¡ç®—å­—ä½“å¤§å°ã€‚ 

    
    
    interfaceÂ IImagePropsÂ {  
    Â Â width:Â number;  
    Â Â height:Â number;  
    }  
    //Â è·å–å›¾ç‰‡çš„å®½é«˜  
    constÂ getImageWHÂ =Â asyncÂ (src):Â Promise<IImageProps>Â =>Â {  
    Â Â constÂ imgÂ =Â newÂ Image();  
    Â Â img.srcÂ =Â src;  
    Â Â awaitÂ newÂ Promise((resolve)Â =>Â (img.onloadÂ =Â resolve));Â Â //Â ç­‰å›¾ç‰‡åŠ è½½å®Œ  
    Â Â returnÂ newÂ Promise((resolve)Â =>Â {  
    Â Â Â Â resolve({  
    Â Â Â Â Â Â width:Â img.width,  
    Â Â Â Â Â Â height:Â img.height,  
    Â Â Â Â });  
    Â Â });  
    };  
    constÂ genOSSImageWaterMarkÂ =Â asyncÂ (imgSrc:Â string)Â =>Â {  
    Â Â constÂ {Â userName,Â userPhoneÂ }Â =Â JSON.parse(window.localStorage.getItem('userInfo')Â ||Â '{}');  
    Â Â constÂ imgTypeÂ =Â imgSrc.split('.').slice(-1)[0];  
    Â Â constÂ {Â width,Â heightÂ }Â =Â awaitÂ getImageWH(imgSrc);  
    Â Â constÂ minÂ =Â Math.min(width,Â height);  
    Â Â //Â æ ¹æ®å®˜ç½‘ä¸Šçš„æµ‹è¯•å›¾ç‰‡ï¼Œå®½åº¦ä¸º400ï¼Œè®¾ç½®å­—ä½“ä¸º10ï¼Œæ°´å°å±•ç¤ºæ•ˆæœå¾ˆå¥½ï¼Œæ‰€ä»¥å›¾ç‰‡æ¯”ä¸º40  
    Â Â constÂ sizeÂ =Â Math.ceil(minÂ /Â 40);  
    Â Â constÂ srcÂ =Â `${imgSrc}?${  
    Â Â Â Â imgTypeÂ !==Â 'jpg'Â ?Â 'x-oss-process=image/format,jpg,'Â :Â ''  
    Â Â }x-oss-process=image/watermark,text_${getSafeBase64Code(  
    Â Â Â Â `${userName}-${userPhone}`  
    Â Â )},rotate_325,t_100,color_ff0000,size_${size},fill_1,g_nw,x_30,y_30`;  
    Â Â returnÂ src;  
    };  
    

æ•ˆæœå¦‚ä¸‹ï¼š

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn43zzBVXnFKff4VuxqSrzf098nDjQjM1E1d3JLoX8edBicBSDvp0ia25qA/640?wx_fmt=png&from=appmsg)
![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn4q5y1G297gxtQ2ZNF8jPEtMnrCWfAiaEdVwdtYgqpERfwXQsMOLrXLIQ/640?wx_fmt=png&from=appmsg)

æ³¨æ„ç‚¹â‘¢

  * **é—®é¢˜ï¼š**

ç”¨æˆ·ç›´æ¥å°†åç¼€åˆ äº†ï¼Œæ°´å°ä¹Ÿå°±æ²¡äº†

  * **è§£å†³æ–¹å¼ï¼š**

oss è®¾ç½®å®‰å…¨çº§åˆ«ï¼Œä¸å¸¦æ°´å°ä¸å¯è®¿é—®

####  é€šè¿‡canvasç»™å›¾ç‰‡å¢åŠ æ°´å°

æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

  * å›¾ç‰‡è·¯å¾„è½¬æˆ canvas 
  * canvas æ·»åŠ æ°´å° 
  * canvas è½¬æˆ img 

ä»£ç å®ç°

    
    
    constÂ genOSSImageWaterMarkÂ =Â asyncÂ (imgSrc:Â string)Â =>Â {  
    Â Â constÂ canvasÂ =Â document.createElement('canvas');  
    Â Â //Â â‘ Â å›¾ç‰‡è·¯å¾„è½¬æˆcanvas  
    Â Â awaitÂ imgSrc2Canvas(canvas,Â imgSrc);  
    Â Â //Â â‘¡Â canvasæ·»åŠ æ°´å°  
    Â Â addWatermark(canvas);  
      
    Â Â //Â â‘¢Â canvasè½¬æˆimg  
    Â Â returnÂ canvas.toDataURL('image/png');  
    };  
    

ä½¿ç”¨

    
    
    constÂ genOSSImageWaterMarkÂ =Â asyncÂ (imgSrc:Â string)Â =>Â {  
    Â Â constÂ canvasÂ =Â document.createElement('canvas');  
    Â Â awaitÂ imgSrc2Canvas(canvas,Â imgSrc);  
    Â Â addWatermark(canvas);  
      
    Â Â returnÂ canvas.toDataURL('image/png');  
    };  
    

#####  å›¾ç‰‡è·¯å¾„è½¬æˆcanvas

    
    
    constÂ imgSrc2CanvasÂ =Â (cav:Â HTMLCanvasElement,Â imgSrc:Â string)Â =>Â {  
    Â Â returnÂ newÂ Promise(asyncÂ (resolve)Â =>Â {  
    Â Â Â Â constÂ imageÂ =Â newÂ Image();  
    Â Â Â Â image.srcÂ =Â imgSrc;  
    Â Â Â Â //Â â‘ Â ä¸ºå›¾ç‰‡è®¾ç½®crossOriginå±æ€§ï¼Œé˜²æ­¢FailedÂ toÂ executeÂ 'toDataURL'Â onÂ 'HTMLCanvasElement'  
    Â Â Â Â image.setAttribute('crossOrigin',Â 'anonymous');  
    Â Â Â Â //Â â‘¡Â è§£å†³æ¸²æŸ“å›¾ç‰‡ä¸ºé€æ˜å›¾å±‚  
    Â Â Â Â awaitÂ newÂ Promise((resolve)Â =>Â (image.onloadÂ =Â resolve));  
    Â Â Â Â cav.widthÂ =Â image.width;  
    Â Â Â Â cav.heightÂ =Â image.height;  
    Â Â Â Â constÂ ctxÂ =Â cav.getContext('2d');  
    Â Â Â Â ifÂ (ctx)Â {  
    Â Â Â Â Â Â ctx.drawImage(image,Â 0,Â 0);  
    Â Â Â Â }  
    Â Â Â Â resolve(cav);  
    Â Â });  
    };  
    

#####  canvasæ·»åŠ æ–‡å­—æ°´å°

  * é€šè¿‡äºŒç»´æ•°ç»„çš„æ¸²æŸ“ï¼Œæ¥å¡«å……æ–‡æœ¬ 

  *   

    * é€šè¿‡ç”»å¸ƒçš„å®½åº¦ä»¥åŠæ°´å°çš„å®½åº¦æ¥è®¡ç®— X è½´çš„æ¸²æŸ“æ¬¡æ•° 
    * é€šè¿‡ç”»å¸ƒçš„å®½åº¦ä»¥åŠä½ æƒ³æ‰“å°çš„ç–å¯†ç¨‹åº¦æ¥è®¡ç®— Y è½´çš„æ¸²æŸ“æ¬¡æ•° 

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn47MrNIZTCg2EArX1p2Wkvkq9wEEeg7hZhEMWNheDPZBtaoB3lHoKMkw/640?wx_fmt=png&from=appmsg)

    
    
    constÂ addWatermarkÂ =Â asyncÂ (canvas,Â imgSrc)Â =>Â {  
    Â Â constÂ {Â userName,Â userPhoneÂ }Â =Â JSON.parse(window.localStorage.getItem('userInfo')Â ||Â '{}');  
    Â Â constÂ ctxÂ =Â canvas.getContext('2d');  
    Â Â ctx.fillStyleÂ =Â 'rgba(100,100,100,0.2)';Â //Â å­—ä½“é¢œè‰²  
    Â Â ctx.fontÂ =Â `24pxÂ serif`;  
    Â Â ctx.translate(0,Â 0);  
    Â Â ctx.rotate((5Â *Â Math.PI)Â /Â 180);Â //Â æ—‹è½¬è§’åº¦  
      
    Â Â constÂ repeatXÂ =Â Math.floor(canvas.widthÂ /Â 240);Â //Â 100Â ä¸ºæ¯ä¸ªæ°´å°çš„åŸºæœ¬å®½åº¦  
    Â Â constÂ repeatYÂ =Â Math.floor(canvas.heightÂ /Â 150);  
    Â Â forÂ (letÂ iÂ =Â 0;Â iÂ <Â repeatX;Â i++)Â {  
    Â Â Â Â forÂ (letÂ jÂ =Â 1;Â jÂ <Â repeatY;Â j++)Â {  
    Â Â Â Â Â Â ctx.fillText(`${userName}-${userPhone}`,Â 240Â *Â 2Â *Â i,Â 150Â *Â j);Â //Â æ§åˆ¶æ°´å°çš„ç–å¯†  
    Â Â Â Â }  
    Â Â }  
    };  
    

é¡µé¢æ•ˆæœå¦‚ä¸‹ï¼š

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn4gkg3ia6uspYNTZSokCVZ38pBKu6SPNXb5T96N2w1fmtWsmykdmQgnOQ/640?wx_fmt=png&from=appmsg)

#####  æ³¨æ„ç‚¹

æ³¨æ„ç‚¹â‘ ï¼š

  * é—®é¢˜ï¼šé¡µé¢æŠ¥é”™å¦‚ä¸‹ 

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn4I02hMgvbB3nMLsRJGbDmGP6sMdfXtU25mu1Nqus5qic59NCIWdQR5IQ/640?wx_fmt=png&from=appmsg)

  * åŸå› ï¼šå½“ img å…ƒç´ çš„ src ä¸ç¬¦åˆåŒæºå‡†åˆ™æ—¶ï¼Œä¼šé˜»æ­¢è¯»å– canvas çš„å†…å®¹ã€‚å› ä¸ºæ­¤æ—¶ img å…ƒç´ æ”¾åœ¨ canvas ä¸­æ—¶ï¼Œcanvas å…ƒç´ ä¼šè¢«æ ‡è®°ä¸ºè¢«æ±¡æŸ“çš„ï¼Œè€Œåœ¨è¢«æ±¡æŸ“çš„ canvas ä¸­è°ƒç”¨ toDataUrl å°†ä¼šæŠ¥é”™ 
  * è§£å†³æ–¹æ¡ˆï¼š 

    
    
    //Â ä¸ºimageè®¾ç½®crossOriginå±æ€§  
    image.setAttribute('crossOrigin',Â 'anonymous');  
    

æ³¨æ„ç‚¹â‘¡ï¼š

  * **é—®é¢˜ï¼šæ¸²æŸ“çš„å›¾ç‰‡ä¸ºé€æ˜çš„å›¾ç‰‡**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicFia0V0o3icAiblWsgnqFLVTn4b7nYS3qdQQibtBfibBg5UtgbcgE4iahzPoF26By99Aib8ibn6CzgUQ4TKdQ/640?wx_fmt=png&from=appmsg)

  * åŸå› ï¼šå›¾ç‰‡è¿˜æœªæ¸²æŸ“å®Œï¼Œå°±è¿”å›äº† canvasã€‚ 
  * è§£å†³æ–¹æ¡ˆï¼šç­‰å›¾ç‰‡æ¸²æŸ“å®Œäº†ï¼Œå†å¼€å§‹ç”»åˆ° canvas ä¸­ 

    
    
    awaitÂ newÂ Promise((resolve)Â =>Â (image.onloadÂ =Â resolve));  
    

##  æ€»ç»“

æœ¬æ–‡ä¸»è¦è®²äº†ä¸¤ä¸ªè¯é¢˜ï¼šé¡µé¢æ°´å° & å›¾ç‰‡æ°´å°ã€‚é¡µé¢æ°´å°å¾ˆç®€å•ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯åˆ©ç”¨ canvas æ¸²æŸ“æ°´å°ï¼Œå†åˆ©ç”¨ä¼ªç±»å°† canvas
çš„æ°´å°æ¸²æŸ“åœ¨ç‰¹å®šçš„åŒºåŸŸã€‚å›¾ç‰‡ç›¸å¯¹è€Œè¨€ä¼šå¤æ‚ä¸€äº›ï¼Œåœ¨æ¸²æŸ“æ°´å°ä¹‹å‰ï¼Œå¾—å…ˆæŠŠå›¾ç‰‡æ¸²æŸ“ä¸Šå»ï¼Œé’ˆå¯¹å¤§å›¾ï¼Œæ€§èƒ½å¯èƒ½ä¼šæ…¢ä¸€ç‚¹ã€‚æ‰€ä»¥ï¼Œå¦‚æœå¯¹æ°´å°è¦æ±‚ä¸æ˜¯å¾ˆä¸¥æ ¼å¹¶ä¸”å›¾ç‰‡æ˜¯å­˜å‚¨åœ¨
oss çš„ï¼Œé‚£åˆ©ç”¨ oss æ¥åŠ æ°´å°ä¹Ÿä¸å¤±ä¸ºä¸€ç§å¥½é€‰æ‹©ã€‚ä½†å¦‚æœä»å®‰å…¨æ€§æ¥è€ƒè™‘ï¼Œé‚£è‚¯å®šæ˜¯æœåŠ¡ç«¯åŠ æ°´å°ä¼šæ›´åˆé€‚ä¸€ç‚¹ã€‚

##  æœ€å

ğŸ“š å°èŒ—æ–‡ç« æ¨èï¼š

  * [ ä¸€æ–‡äº†è§£Webpackä¸­Tapableäº‹ä»¶æœºåˆ¶ ](http://mp.weixin.qq.com/s?__biz=Mzg4OTkwMTY3Mg==&mid=2247484670&idx=1&sn=28c8ad10f9e442145b109c13172ee647&chksm=cfe583f9f8920aef479cf3579345af5ee5010222e2246bc986546c6cc0affa54750ad2d762bd&scene=21#wechat_redirect)
  * [ å¤èŒ—æ‰“å°æœºæŠ€æœ¯çš„æ¼”è¿› ](http://mp.weixin.qq.com/s?__biz=Mzg4OTkwMTY3Mg==&mid=2247484498&idx=1&sn=79ba32d922199176369d4f4d05e2faea&chksm=cfe58355f8920a43a9b889d96ab2d582f1fbb9b7b2366d7f8431326b82cdaecc58164f2e25eb&scene=21#wechat_redirect)
  * [ 5åˆ†é’Ÿå¸¦ä½ äº†è§£ï¼Œå¤èŒ—çš„ä»£ç å‘å¸ƒä¸å›æ»š ](http://mp.weixin.qq.com/s?__biz=Mzg4OTkwMTY3Mg==&mid=2247484454&idx=1&sn=57684faf0e2988d922339f45d118efa3&chksm=cfe58321f8920a3718c7e6e1ee69a3380a1775f3c4bcffb75c26ad21fec5e12254b22954358b&scene=21#wechat_redirect)

å…³æ³¨å…¬ä¼—å·ã€ŒGoodmeå‰ç«¯å›¢é˜Ÿã€ï¼Œè·å–æ›´å¤šå¹²è´§å®è·µï¼Œæ¬¢è¿äº¤æµåˆ†äº«~

  

é¢„è§ˆæ—¶æ ‡ç­¾ä¸å¯ç‚¹

ä¿®æ”¹äº

å¾®ä¿¡æ‰«ä¸€æ‰«  
å…³æ³¨è¯¥å…¬ä¼—å·





****



****



Ã—  åˆ†æ

  æ”¶è—

