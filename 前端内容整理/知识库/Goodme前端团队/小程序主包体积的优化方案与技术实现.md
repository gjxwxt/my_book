![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/TpB2QHJbiaicEL03uRuABrTf1FXOkiceVxzibcEm3icvErBeqDpxdZbrT1VRW1HlXgAJWgibOduepk8mkfGfQbPLibeyQ/0?wx_fmt=jpeg)

#  å°ç¨‹åºä¸»åŒ…ä½“ç§¯çš„ä¼˜åŒ–æ–¹æ¡ˆä¸æŠ€æœ¯å®ç°

åŸåˆ›  æ½˜å®‡  [ Goodmeå‰ç«¯å›¢é˜Ÿ ](javascript:void\(0\);)

__ _ _ _ _

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicEL03uRuABrTf1FXOkiceVxzqpIbUF1qXSqmWdibV9LMcxHp1HibILib5fEjmAzWx42LCmndQciaoZMDMg/640?wx_fmt=png&from=appmsg)  

##  å¼•è¨€

åœ¨ä½¿ç”¨Taroå¼€å‘åå¤§å‹å°ç¨‹åºåº”ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ç»å¸¸ä¼šé‡åˆ°è¿™ä¹ˆä¸ªé—®é¢˜ï¼šå°ç¨‹åºçš„ä¸»åŒ…ä½“ç§¯è¶…è¿‡äº†2Mï¼Œæ²¡åŠæ³•å‘å¸ƒã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæœ¬æ–‡è®²ä¸€è®²æˆ‘åœ¨ä¸šåŠ¡ä¸­ç»å¸¸ä½¿ç”¨åˆ°çš„4ç§ä¼˜åŒ–æ‰‹æ®µã€‚

##  ä¼˜åŒ–æ–¹å¼

###  é¡µé¢åˆ†åŒ…

å¾®ä¿¡ä¸»åŒ…ä½“ç§¯é™åˆ¶ ` 2MB ` ä¸»åŒ…ç©ºé—´å¯¸åœŸå¯¸é‡‘ï¼Œä»…æ”¾ç½®é»˜è®¤å¯åŠ¨é¡µé¢/TabBar é¡µé¢ï¼Œå…¶ä»–é¡µé¢å‡è¿ç§»è‡³åˆ†åŒ…ã€‚è¿™ä¹Ÿæ˜¯ä¸»åŒ…ä½“ç§¯æœ€åŸºæœ¬çš„ä¼˜åŒ–æ–¹å¼ã€‚

###  å…¬å…±æ¨¡å—åˆ†åŒ…

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicEL03uRuABrTf1FXOkiceVxzA5LAGib8apsXaRr3fBAMr5oa1gicsOWIXMT0X81cxiaoMataVbxRM1jibA/640?wx_fmt=png&from=appmsg)
æ”¹é€ ååˆ†åŒ…åŠ è½½çš„é¡µé¢ä½“ç§¯ä¸è®¡å…¥ä¸»åŒ…ä½“ç§¯å†…ï¼Œä½†æ˜¯åœ¨é»˜è®¤é…ç½®ä¸‹è¢«å¤šä¸ªé¡µé¢æ‰€å¼•ç”¨çš„æ¨¡å—ä¼šè¢«æ‰“åŒ…è¿›ä¸»åŒ…ã€‚è¿™é‡Œæˆªå–äº†æœªåšä¼˜åŒ–é¡µé¢åˆ†åŒ…åç›´æ¥æ‰“åŒ…åçš„ä»£ç ä¾èµ–åˆ†æå›¾ã€‚å…¶ä¸­ï¼š

  * ` common.js ` åŒ…å«äº†ä¸šåŠ¡ä¸­çš„å…¬å…±ç»„ä»¶ã€å·¥å…·æ–¹æ³•ã€ ` hooks ` ç­‰é€»è¾‘ 
  * ` common.wxss ` åŒ…å«äº†ä¸šåŠ¡ä¸­å…¬å…±ç»„ä»¶çš„æ ·å¼ã€å…¨å±€æ ·å¼ 
  * ` vendors.js ` åŒ…å«äº†ä¸‰æ–¹ä¾èµ–é€»è¾‘ 

####  è§£å†³æ–¹æ¡ˆ

é‚£ä¹ˆæˆ‘ä»¬èƒ½ä¸èƒ½è¯†åˆ«å“ªäº›é¡µé¢ä½¿ç”¨äº†è¿™äº›å…¬å…±æ¨¡å—ï¼Œå¦‚æœæŸä¸ªå…¬å…±æ¨¡å—è™½ç„¶è¢«å¤šä¸ªåˆ†åŒ…ä½¿ç”¨ï¼Œä½†æ˜¯ä½¿ç”¨å®ƒçš„åˆ†åŒ…å‡ä¸åœ¨ä¸»åŒ…ä¸­é‚£ä¹ˆæˆ‘ä»¬è¿™ä¸ªæ¨¡å—æ˜¯ä¸æ˜¯åº”è¯¥è¢«æ‰“åŒ…è¿›å¯¹åº”çš„åˆ†åŒ…å†…å‡å°‘ä¸»åŒ…ä½“ç§¯å ç”¨ã€‚

####  æŠ€æœ¯å®ç°

> æ–‡æ¡£é“¾æ¥ï¼šhttps://docs.taro.zone/docs/config-detail#minioptimizemainpackage

` Taro ` é…ç½® ` mini.optimizeMainPackage ` å°±èƒ½å®ç°è¿™ä¸€åŠŸèƒ½ ` Taro `
å®˜æ–¹å¯¹è¿™ä¸€é…ç½®çš„æè¿°æ˜¯ï¼šå¯ä»¥é¿å…ä¸»åŒ…æ²¡æœ‰å¼•å…¥çš„ ` module ` ä¸è¢«æå–åˆ° ` commonChunks ` ä¸­ï¼Œè¯¥åŠŸèƒ½ä¼šåœ¨æ‰“åŒ…æ—¶åˆ†æ `
module ` å’Œ ` chunk ` çš„ä¾èµ–å…³ç³»ï¼Œç­›é€‰å‡ºä¸»åŒ…æ²¡æœ‰å¼•ç”¨åˆ°çš„ ` module ` æŠŠå®ƒæå–åˆ°åˆ†åŒ…å†…ã€‚å¼€å¯ `
mini.optimizeMainPackage ` åçš„ä»£ç ä¾èµ–åˆ†æå›¾å¦‚ä¸‹ï¼š
![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicEL03uRuABrTf1FXOkiceVxzKRG76lVVZpiboCgNg4iaIQ7gYhPNLZq16o3Y4NicZpr3D0G8mK5c26ktg/640?wx_fmt=png&from=appmsg)

####  æºç è§£æ

é‚£ä¹ˆ ` Taro ` æ˜¯å¦‚ä½•å®ç°è¿™ä¸€åŠŸèƒ½çš„å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹æºç ï¼š

  1. æ”¶é›†åˆ†åŒ…å…¥å£æ•°æ®ç”¨äºåç»­åˆ¤æ–­ ` chunk ` æ˜¯å¦å±äºåˆ†åŒ… 

    
    
    constÂ PLUGIN_NAMEÂ =Â 'MiniSplitChunkPlugin'  
      
    exportÂ defaultÂ classÂ MiniSplitChunksPluginÂ extendsÂ SplitChunksPluginÂ {  
      
    Â Â Â //Â åˆ†åŒ…é…ç½®  
    Â Â subPackages:Â SubPackage[]  
      
    Â Â //Â åˆ†åŒ…æ ¹è·¯å¾„  
    Â Â subRoots:Â string[]  
      
    Â Â //Â åˆ†åŒ…æ ¹è·¯å¾„æ­£åˆ™  
    Â Â subRootRegExps:Â RegExp[]  
      
    Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...Â   
      
    Â Â applyÂ (compiler:Â any)Â {  
    Â Â Â Â this.contextÂ =Â compiler.context  
      
    Â Â Â Â //Â è·å–åˆ†åŒ…é…ç½®  
    Â Â Â Â this.subPackagesÂ =Â this.getSubpackageConfig(compiler).map((subPackage:Â SubPackage)Â =>Â ({  
    Â Â Â Â Â Â ...subPackage,  
    Â Â Â Â Â Â root:Â this.formatSubRoot(subPackage.root)Â //Â æ ¼å¼åŒ–æ ¹è·¯å¾„ï¼Œå»æ‰å°¾éƒ¨çš„/  
    Â Â Â Â }))  
      
    Â Â Â Â //Â è·å–åˆ†åŒ…æ ¹è·¯å¾„  
    Â Â Â Â this.subRootsÂ =Â this.subPackages.map((subPackage:Â SubPackage)Â =>Â subPackage.root)  
      
    Â Â Â Â //Â ç”Ÿæˆåˆ†åŒ…æ ¹è·¯å¾„æ­£åˆ™  
    Â Â Â Â this.subRootRegExpsÂ =Â this.subRoots.map((subRoot:Â string)Â =>Â newÂ RegExp(`^${subRoot}\\/`))  
      
    Â Â Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...Â   
    Â Â }  
      
    Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
    }  
    

  2. æ‰¾åˆ°åˆ†åŒ…å…¥å£ ` chunk ` ã€‚å¾ªç¯æ„æˆ ` chunk ` çš„ ` module ` ã€‚å…¶ä¸­æ²¡æœ‰è¢«ä¸»åŒ…å¼•ç”¨ï¼Œä¸”è¢«å¤šä¸ªåˆ†åŒ…å¼•ç”¨çš„è®°å½•åœ¨ ` subCommonDeps ` ä¸­ã€‚å¹¶åŸºäº ` subCommonDeps ` ç”Ÿæˆæ–°çš„ ` cacheGroups ` é…ç½®ç”¨äº ` SplitChunksPlugin ` ä½œä¸ºé…ç½®æ‹†åˆ† ` chunks ` ã€‚ 

    
    
    constÂ PLUGIN_NAMEÂ =Â 'MiniSplitChunkPlugin'  
      
    exportÂ defaultÂ classÂ MiniSplitChunksPluginÂ extendsÂ SplitChunksPluginÂ {  
      
    Â Â //Â æ‰€æœ‰åˆ†åŒ…å…¬å…±ä¾èµ–  
    Â Â subCommonDeps:Â Map<string,Â DepInfo>  
      
    Â Â //Â å„ä¸ªåˆ†åŒ…çš„å…¬å…±ä¾èµ–Map  
    Â Â chunkSubCommons:Â Map<string,Â Set<string>>  
      
    Â Â //Â åˆ†åŒ…ä¸‰æ–¹ä¾èµ–  
    Â Â subPackagesVendors:Â Map<string,Â webpack.compilation.Chunk>  
      
      
    Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
      
    Â Â applyÂ (compiler:Â any)Â {  
      
    Â Â Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
      
    Â Â Â Â compiler.hooks.compilation.tap(PLUGIN_NAME,Â (compilation:Â any)Â =>Â {  
    Â Â Â Â Â Â compilation.hooks.optimizeChunks.tap(PLUGIN_NAME,Â (chunks:Â webpack.compilation.Chunk[])Â =>Â {  
    Â Â Â Â Â Â Â Â constÂ splitChunksOriginConfigÂ =Â {  
    Â Â Â Â Â Â Â Â Â Â ...compiler?.options?.optimization?.splitChunks  
    Â Â Â Â Â Â Â Â }  
      
    Â Â Â Â Â Â Â Â this.subCommonDepsÂ =Â newÂ Map()  
    Â Â Â Â Â Â Â Â this.chunkSubCommonsÂ =Â newÂ Map()  
    Â Â Â Â Â Â Â Â this.subPackagesVendorsÂ =Â newÂ Map()  
      
    Â Â Â Â Â Â Â Â /**  
    Â Â Â Â Â Â Â Â Â *Â æ‰¾å‡ºåˆ†åŒ…å…¥å£chunks  
    Â Â Â Â Â Â Â Â Â */  
    Â Â Â Â Â Â Â Â constÂ subChunksÂ =Â chunks.filter(chunkÂ =>Â this.isSubChunk(chunk))  
      
    Â Â Â Â Â Â Â Â //Â ä¸å­˜åœ¨åˆ†åŒ…  
    Â Â Â Â Â Â Â Â ifÂ (subChunks.lengthÂ ===Â 0)Â {  
    Â Â Â Â Â Â Â Â Â Â this.optionsÂ =Â SplitChunksPlugin.normalizeOptions(splitChunksOriginConfig)  
    Â Â Â Â Â Â Â Â Â Â return  
    Â Â Â Â Â Â Â Â }  
      
    Â Â Â Â Â Â Â Â subChunks.forEach((subChunk:Â webpack.compilation.Chunk)Â =>Â {  
    Â Â Â Â Â Â Â Â Â Â subChunk.modulesIterable.forEach((module:Â any)Â =>Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
    Â Â Â Â Â Â Â Â Â Â Â Â constÂ chunks:Â webpack.compilation.Chunk[]Â =Â Array.from(module.chunksIterable)  
    Â Â Â Â Â Â Â Â Â Â Â Â constÂ chunkNames:Â string[]Â =Â chunks.map(chunkÂ =>Â chunk.name)  
    Â Â Â Â Â Â Â Â Â Â Â Â /**  
    Â Â Â Â Â Â Â Â Â Â Â Â Â *Â æ‰¾å‡ºæ²¡æœ‰è¢«ä¸»åŒ…å¼•ç”¨ï¼Œä¸”è¢«å¤šä¸ªåˆ†åŒ…å¼•ç”¨çš„moduleï¼Œå¹¶è®°å½•åœ¨subCommonDepsä¸­  
    Â Â Â Â Â Â Â Â Â Â Â Â Â */  
    Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (!this.hasMainChunk(chunkNames)Â &&Â this.isSubsDep(chunkNames))Â {  
      
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â æ­¤å¤„ç”ŸæˆÂ subCommonDepsã€subCommonDepChunksÂ ç”¨äºç”Ÿæˆæ–°çš„cacheGroupsé…ç½®  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
    Â Â Â Â Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â Â Â Â Â })  
    Â Â Â Â Â Â Â Â })  
      
    Â Â Â Â Â Â Â Â /**  
    Â Â Â Â Â Â Â Â Â *Â ç”¨æ–°çš„optioné…ç½®ç”Ÿæˆæ–°çš„cacheGroupsé…ç½®  
    Â Â Â Â Â Â Â Â Â */  
    Â Â Â Â Â Â Â Â this.optionsÂ =Â SplitChunksPlugin.normalizeOptions({  
    Â Â Â Â Â Â Â Â Â Â ...splitChunksOriginConfig,  
    Â Â Â Â Â Â Â Â Â Â cacheGroups:Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â ...splitChunksOriginConfig?.cacheGroups,  
    Â Â Â Â Â Â Â Â Â Â Â Â ...this.getSubPackageVendorsCacheGroup(),Â   
    Â Â Â Â Â Â Â Â Â Â Â Â ...this.getSubCommonCacheGroup()Â //Â è¯¥æ–¹æ³•è¿”å›å€¼åŸºäºÂ this.subCommonDepsÂ ç”Ÿæˆ  
    Â Â Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â Â Â })  
    Â Â Â Â Â Â })  
      
    Â Â Â Â })  
    Â Â }  
    Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
    }  
    

  3. åœ¨ ` SplitChunksPlugin ` å®Œæˆ ` chunks ` æ‹†åˆ†åæ”¶é›†åˆ†åŒ…ä¸‹çš„ ` sub-vendors ` å’Œ ` sub-common ` ä¸‹çš„å…¬å…±æ¨¡å—ä¿¡æ¯ 

    
    
    exportÂ defaultÂ classÂ MiniSplitChunksPluginÂ extendsÂ SplitChunksPluginÂ {  
      
    Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
      
    Â Â applyÂ (compiler:Â any)Â {  
      
    Â Â Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
      
    Â Â Â Â compiler.hooks.compilation.tap(PLUGIN_NAME,Â (compilation:Â any)Â =>Â {  
      
    Â Â Â Â Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
      
    Â Â Â Â Â Â compilation.hooks.afterOptimizeChunks.tap(PLUGIN_NAME,Â (chunks:Â webpack.compilation.Chunk[])Â =>Â {  
    Â Â Â Â Â Â Â Â constÂ existSubCommonDepsÂ =Â newÂ Map()  
      
    Â Â Â Â Â Â Â Â chunks.forEach(chunkÂ =>Â {  
    Â Â Â Â Â Â Â Â Â Â constÂ chunkNameÂ =Â chunk.name  
      
    Â Â Â Â Â Â Â Â Â Â ifÂ (this.matchSubVendors(chunk))Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â constÂ subRootÂ =Â this.subRoots.find(subRootÂ =>Â newÂ RegExp(`^${subRoot}\\/`).test(chunkName))Â asÂ string  
      
    Â Â Â Â Â Â Â Â Â Â Â Â this.subPackagesVendors.set(subRoot,Â chunk)  
    Â Â Â Â Â Â Â Â Â Â }  
      
    Â Â Â Â Â Â Â Â Â Â ifÂ (this.matchSubCommon(chunk))Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â constÂ depNameÂ =Â chunkName.replace(newÂ RegExp(`^${this.subCommonDir}\\/(.*)`),Â '$1')  
      
    Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (this.subCommonDeps.has(depName))Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â existSubCommonDeps.set(depName,Â this.subCommonDeps.get(depName))  
    Â Â Â Â Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â Â Â })  
      
    Â Â Â Â Â Â Â Â this.setChunkSubCommons(existSubCommonDeps)  
    Â Â Â Â Â Â Â Â //Â è¿™é‡Œæ”¶é›†äº†SplitChunksPluginÂ å®ŒæˆÂ chunksÂ æ‹†åˆ†ååˆ†åŒ…å†…çš„Â subCommonDepï¼ˆps:Â è¿™é‡Œçš„èµ‹å€¼æœ‰ç‚¹å¥‡æ€ªï¼Œå› ä¸ºåç»­çš„æµç¨‹å¹¶æ²¡æœ‰ä½¿ç”¨ï¼‰  
    Â Â Â Â Â Â Â Â this.subCommonDepsÂ =Â existSubCommonDeps  
    Â Â Â Â Â Â })  
    Â Â Â Â }  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }  
    Â Â   
    Â Â setChunkSubCommonsÂ (subCommonDeps:Â Map<string,Â DepInfo>)Â {  
    Â Â Â Â constÂ chunkSubCommons:Â Map<string,Â Set<string>>Â =Â newÂ Map()  
      
    Â Â Â Â subCommonDeps.forEach((depInfo:Â DepInfo,Â depName:Â string)Â =>Â {  
    Â Â Â Â Â Â constÂ chunks:Â string[]Â =Â [...depInfo.chunks]  
      
    Â Â Â Â Â Â chunks.forEach(chunkÂ =>Â {  
    Â Â Â Â Â Â Â Â ifÂ (chunkSubCommons.has(chunk))Â {  
    Â Â Â Â Â Â Â Â Â Â constÂ chunkSubCommonÂ =Â chunkSubCommons.get(chunk)Â asÂ Set<string>  
      
    Â Â Â Â Â Â Â Â Â Â chunkSubCommon.add(depName)  
    Â Â Â Â Â Â Â Â Â Â chunkSubCommons.set(chunk,Â chunkSubCommon)  
    Â Â Â Â Â Â Â Â }Â elseÂ {  
    Â Â Â Â Â Â Â Â Â Â chunkSubCommons.set(chunk,Â newÂ Set([depName]))  
    Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â })  
    Â Â Â Â })  
    Â Â Â Â this.chunkSubCommonsÂ =Â chunkSubCommons  
    Â Â }  
    Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
    }  
    

  4. åŸºäºæ”¶é›†çš„åˆ†åŒ…ä¸‹çš„ ` sub-vendors ` å’Œ ` sub-common ` ä¸‹çš„å…¬å…±æ¨¡å—ä¿¡æ¯ã€‚ä¸ºåˆ†åŒ… ` require ` å¯¹åº”å…¬å…±æ¨¡å—ã€‚ ` SplitChunksPlugin ` å¯¼å‡ºè·¯å¾„ä¸ºç¼–è¯‘äº§ç‰©æ ¹ç›®å½•å³ä¸»åŒ…æ ¹ç›®å½•ï¼Œè¿™é‡Œä¸ºäº†ä¸å ä¸»åŒ…ä½“ç§¯æ‰€ä»¥è¿™é‡Œéœ€è¦å°† ` sub-common ` è¿ç§»è‡³å¯¹åº”åˆ†åŒ…ï¼Œæ•…æ­¤å¤„ ` require ` çš„æ–‡ä»¶è·¯å¾„éƒ½æ˜¯åŸºäºåˆ†åŒ…æ ¹ç›®å½•ã€‚ 

    
    
    exportÂ defaultÂ classÂ MiniSplitChunksPluginÂ extendsÂ SplitChunksPluginÂ {  
      
    Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
      
      
    Â Â applyÂ (compiler:Â any)Â {  
      
    Â Â Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
      
    Â Â Â Â compiler.hooks.compilation.tap(PLUGIN_NAME,Â (compilation:Â any)Â =>Â {  
    Â Â Â Â Â Â compilation.chunkTemplate.hooks.renderWithEntry.tap(PLUGIN_NAME,Â (modules,Â chunk)Â =>Â {  
    Â Â Â Â Â Â Â Â ifÂ (this.isSubChunk(chunk))Â {  
    Â Â Â Â Â Â Â Â Â Â constÂ chunkNameÂ =Â chunk.name  
    Â Â Â Â Â Â Â Â Â Â constÂ chunkSubRootÂ =Â this.subRoots.find(subRootÂ =>Â newÂ RegExp(`^${subRoot}\\/`).test(chunkName))Â asÂ string  
    Â Â Â Â Â Â Â Â Â Â constÂ chunkAbsulutePathÂ =Â path.resolve(this.distPath,Â chunkName)  
    Â Â Â Â Â Â Â Â Â Â constÂ sourceÂ =Â newÂ ConcatSource()  
    Â Â Â Â Â Â Â Â Â Â constÂ hasSubVendorsÂ =Â this.subPackagesVendors.has(chunkSubRoot)  
    Â Â Â Â Â Â Â Â Â Â constÂ subVendorsÂ =Â this.subPackagesVendors.get(chunkSubRoot)Â asÂ webpack.compilation.Chunk  
    Â Â Â Â Â Â Â Â Â Â constÂ subCommonÂ =Â [...(this.chunkSubCommons.get(chunkName)Â ||Â [])]  
      
    Â Â Â Â Â Â Â Â Â Â /**  
    Â Â Â Â Â Â Â Â Â Â Â *Â requireè¯¥åˆ†åŒ…ä¸‹çš„sub-vendors  
    Â Â Â Â Â Â Â Â Â Â Â */  
    Â Â Â Â Â Â Â Â Â Â ifÂ (hasSubVendors)Â {  
    Â Â Â //Â ...Â æ­¤å¤„çœç•¥æ–‡ä»¶è·¯å¾„ç”Ÿæˆé€»è¾‘Â ...  
    Â Â Â Â Â Â Â Â Â Â Â Â source.add(`require(${JSON.stringify(relativePath)});\n`)  
    Â Â Â Â Â Â Â Â Â Â }  
      
    Â Â Â Â Â Â Â Â Â Â //Â requireÂ sub-commonä¸‹çš„æ¨¡å—  
    Â Â Â Â Â Â Â Â Â Â ifÂ (subCommon.lengthÂ >Â 0)Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (this.needAllInOne())Â {  
    Â Â Â Â Â Â Â Â //Â ...Â æ­¤å¤„çœç•¥æ–‡ä»¶è·¯å¾„ç”Ÿæˆé€»è¾‘Â ...  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â source.add(`require(${JSON.stringify(relativePath)});\n`)  
    Â Â Â Â Â Â Â Â Â Â Â Â }Â elseÂ {  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â subCommon.forEach(moduleNameÂ =>Â {  
    Â Â Â Â Â //Â ...Â æ­¤å¤„çœç•¥æ–‡ä»¶è·¯å¾„ç”Ÿæˆé€»è¾‘Â ...  
      
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â source.add(`require(${JSON.stringify(relativePath)});\n`)  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â })  
    Â Â Â Â Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â Â Â Â Â }  
      
    Â Â Â Â Â Â Â Â Â Â source.add(modules)  
    Â Â Â Â Â Â Â Â Â Â source.add(';')  
    Â Â Â Â Â Â Â Â Â Â returnÂ source  
    Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â })  
    Â Â Â Â }  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }  
      
    Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
    }  
    

  5. ` require ` çš„æ–‡ä»¶è·¯å¾„åŸºäºåˆ†åŒ…æ ¹ç›®å½•ã€‚æ‰€ä»¥å¯¹åº”çš„æ–‡ä»¶ä¹Ÿéœ€è¦åšè¿ç§»ã€‚ 

    
    
    exportÂ defaultÂ classÂ MiniSplitChunksPluginÂ extendsÂ SplitChunksPluginÂ {  
      
    Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
      
      
    Â Â applyÂ (compiler:Â any)Â {  
      
    Â Â Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
      
    Â Â Â Â compiler.hooks.emit.tapAsync(PLUGIN_NAME,Â this.tryAsync((compilation)Â =>Â {  
    Â Â Â Â Â Â constÂ assetsÂ =Â compilation.assets  
    Â Â Â Â Â Â constÂ subChunksÂ =Â compilation.entries.filter(entryÂ =>Â this.isSubChunk(entry))  
    Â Â Â Â Â Â constÂ needAllInOneÂ =Â this.needAllInOne()  
      
    Â Â Â Â Â Â subChunks.forEach(subChunkÂ =>Â {  
    Â Â Â Â Â Â Â Â constÂ subChunkNameÂ =Â subChunk.name  
    Â Â Â Â Â Â Â Â constÂ subRootÂ =Â this.subRoots.find(subRootÂ =>Â newÂ RegExp(`^${subRoot}\\/`).test(subChunkName))Â asÂ string  
    Â Â Â Â Â Â Â Â constÂ chunkWxssNameÂ =Â `${subChunkName}${FileExtsMap.STYLE}`  
    Â Â Â Â Â Â Â Â constÂ subCommonÂ =Â [...(this.chunkSubCommons.get(subChunkName)Â ||Â [])]  
    Â Â Â Â Â Â Â Â constÂ wxssAbsulutePathÂ =Â path.resolve(this.distPath,Â chunkWxssName)  
    Â Â Â Â Â Â Â Â constÂ subVendorsWxssPathÂ =Â path.join(subRoot,Â `${this.subVendorsName}${FileExtsMap.STYLE}`)  
    Â Â Â Â Â Â Â Â constÂ sourceÂ =Â newÂ ConcatSource()  
      
    Â Â Â Â Â Â Â Â ifÂ (subCommon.lengthÂ >Â 0)Â {  
    Â Â Â Â Â Â Â Â Â Â letÂ hasSubCssCommonÂ =Â false  
    Â Â Â Â Â Â Â Â Â Â subCommon.forEach(moduleNameÂ =>Â {  
      
    Â Â Â Â Â Â Â Â Â Â Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
      
    Â Â Â Â Â Â Â Â Â Â Â Â //Â å¤åˆ¶sub-commonä¸‹çš„èµ„æºåˆ°åˆ†åŒ…ä¸‹  
    Â Â Â Â Â Â Â Â Â Â Â Â forÂ (constÂ keyÂ inÂ FileExtsMap)Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â constÂ extÂ =Â FileExtsMap[key]  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â constÂ assetNameÂ =Â path.join(this.subCommonDir,Â `${moduleName}${ext}`)  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â constÂ subAssetNameÂ =Â path.join(subRoot,Â assetName)  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â constÂ assetSourceÂ =Â assets[normalizePath(assetName)]  
      
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (assetSource)Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â assets[normalizePath(subAssetName)]Â =Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â size:Â ()Â =>Â assetSource.source().length,  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â source:Â ()Â =>Â assetSource.source()  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â Â Â Â Â })  
      
    Â Â Â Â Â Â Â Â Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
    Â Â Â Â Â Â Â Â }  
      
    Â Â Â Â Â Â Â Â ifÂ (assets[normalizePath(subVendorsWxssPath)])Â {  
    Â Â Â Â Â Â Â Â Â Â constÂ subVendorsAbsolutePathÂ =Â path.resolve(this.distPath,Â subVendorsWxssPath)  
    Â Â Â Â Â Â Â Â Â Â constÂ relativePathÂ =Â this.getRealRelativePath(wxssAbsulutePath,Â subVendorsAbsolutePath)  
    Â Â Â Â Â Â Â Â Â Â source.add(`@importÂ ${JSON.stringify(relativePath)};\n`)  
    Â Â Â Â Â Â Â Â }  
      
    Â Â Â Â Â Â Â Â ifÂ (assets[chunkWxssName])Â {  
    Â Â Â Â Â Â Â Â Â Â constÂ originSourceÂ =Â assets[chunkWxssName].source()  
    Â Â Â Â Â Â Â Â Â Â source.add(originSource)  
    Â Â Â Â Â Â Â Â }  
      
    Â Â Â Â Â Â Â Â assets[chunkWxssName]Â =Â {  
    Â Â Â Â Â Â Â Â Â Â size:Â ()Â =>Â source.source().length,  
    Â Â Â Â Â Â Â Â Â Â source:Â ()Â =>Â source.source()  
    Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â })  
      
    Â Â Â Â Â Â //Â åˆ é™¤æ ¹ç›®å½•ä¸‹çš„sub-commonèµ„æºæ–‡ä»¶  
    Â Â Â Â Â Â forÂ (constÂ assetPathÂ inÂ assets)Â {  
    Â Â Â Â Â Â Â Â ifÂ (newÂ RegExp(`^${this.subCommonDir}\\/.*`).test(assetPath))Â {  
    Â Â Â Â Â Â Â Â Â Â deleteÂ assets[assetPath]  
    Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â }  
      
    Â Â Â Â Â Â //Â ...Â çœç•¥éƒ¨åˆ†ä»£ç Â ...  
    Â Â Â Â }))  
    Â Â }  
    }  
      
    

ä»¥ä¸Šå°±æ˜¯ ` MiniSplitChunksPlugin ` å®ç°å…¬å…±æ¨¡å—åˆ†åŒ…çš„æ ¸å¿ƒæµç¨‹

###  å¼•ç”¨æ–¹å¼

åœ¨å®Œæˆå…¬å…±æ¨¡å—åˆ†åŒ…åä¸»åŒ…ä½“ç§¯çš„ç¡®æœ‰æ‰€å‡å°‘ï¼Œä½†æ˜¯åœ¨åç»­çš„è¿­ä»£ä¸­å‘ç°å…¬å…±ç»„ä»¶å¹¶æ²¡æœ‰å…¨éƒ¨éƒ½æŒ‰é¡µé¢åˆ†åŒ…æ‰“åŒ…ã€‚ä»¥ ` @/components ` ä¸¾ä¾‹ï¼Œé€šè¿‡æ’æŸ¥å‘ç°
` @/components ` æ˜¯é€šè¿‡ ` index.ts ` ç»Ÿä¸€å¯¼å‡ºå†…éƒ¨çš„å­æ¨¡å—é¡µé¢é€šè¿‡ ` import { ComponentName }
from '@/components' ` æ–¹å¼å¼•å…¥ã€‚è€Œè¿™ç§å¯¼å‡ºæ–¹å¼ä¼šä½¿ ` webpack ` å°†è¿™ä¸ª ` @/components `
è¯†åˆ«ä¸ºä¸€ä¸ªå•ç‹¬æ¨¡å—ï¼Œç”±äºä¸»åŒ…å†…å­˜åœ¨é¡µé¢å¼•ç”¨ ` @/component ` ä¸‹çš„å…¬å…±ç»„ä»¶ï¼Œæ‰€ä»¥ ` @/components ` ä¼šè¢«å®Œæ•´çš„æ‰“åŒ…è¿›ä¸»åŒ…å†…ã€‚

####  è§£å†³æ–¹æ¡ˆ

è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•å°±æ˜¯å°† ` @/components ` ä¿®æ”¹ä¸º ` @/components/component-path ` ï¼Œè·³è¿‡ `
index.ts ` ç›´æ¥å¼•ç”¨å†…éƒ¨ç»„ä»¶æ–‡ä»¶ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•å°†ç°å­˜é¡¹ç›®ä¸­ä½¿ç”¨çš„ç»„ä»¶å¼•ç”¨è·¯å¾„éƒ½æ›¿æ¢æ‰å‘¢ï¼Ÿ

  * â äººå·¥é€ä¸ªæ›¿æ¢ 
    * éœ€è¦ä¿®æ”¹ä½¿ç”¨åˆ°å…¬å…±ç»„ä»¶çš„ä¸šåŠ¡ä»£ç å·¥ä½œé‡å¤§ä¸”æ˜“å‡ºé”™ 
    * ä¸”åç»­å…¨å±€ç»„ä»¶ä½¿ç”¨ä¹Ÿè¾ƒç¹çéœ€è¦ç›´æ¥å¼•ç”¨æ–‡ä»¶è·¯å¾„ ` @/components/component-path ` ã€‚ 
  * âœ… ä½¿ç”¨ ` babel ` æ’ä»¶æ‰¹é‡æ›¿æ¢ 
    * ä»…éœ€å¼•å…¥æ’ä»¶ ` babel-plugin-import ` åšå¯¹åº”é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç ã€‚ 
    * å¼€å‘æ— æ„Ÿï¼Œ ` @/components ` çš„ä½¿ç”¨æ–¹å¼ä¸å˜ 

####  æŠ€æœ¯å®ç°

  1. å¼•å…¥æ’ä»¶ ` babel-plugin-import ` ï¼Œå¹¶é…ç½®ç»„ä»¶è·¯å¾„ä¸ç»„ä»¶æ–‡ä»¶è·¯å¾„ä¹‹é—´çš„è½¬æ¢å…³ç³» 

    
    
    module.exportsÂ =Â {  
    Â Â plugins:Â [  
    Â Â Â Â [  
    Â Â Â Â Â Â 'import',  
    Â Â Â Â Â Â {  
    Â Â Â Â Â Â Â Â libraryName:Â '@/components',  
    Â Â Â Â Â Â Â Â libraryDirectory:Â '',  
    Â Â Â Â Â Â Â Â transformToDefaultImport:Â false,  
    Â Â Â Â Â Â },  
    Â Â Â Â ],  
    Â Â ],  
    };  
      
    

  2. æŒ‰ç…§é…ç½®çš„æ–‡ä»¶åä¸æ–‡ä»¶è·¯å¾„ä¹‹é—´çš„è½¬æ¢å…³ç³»å®šä¹‰ç»„ä»¶ 

    
    
    //Â componentÂ fileÂ ->Â @/components/component-a  
    exportÂ constÂ ComponentAÂ =Â ()=>Â <View/>  
      
    //Â businessÂ codeÂ   
    importÂ {ComponentA}Â fromÂ '@/components'  
    

è¿™é‡Œéœ€è¦æ³¨æ„å¦‚æœç»„ä»¶è·¯å¾„ä¸ç»„ä»¶åä¸ç¬¦åˆæ‰€é…ç½®çš„è§„èŒƒï¼Œç¼–è¯‘æ—¶ä¼šæ‰¾ä¸åˆ°å¯¹åº”çš„ç»„ä»¶ã€‚

###  å›¾ç‰‡èµ„æºä¼˜åŒ–

![](https://mmbiz.qpic.cn/sz_mmbiz_png/TpB2QHJbiaicEL03uRuABrTf1FXOkiceVxzVU0gMUc0bK9tYp2OeL0BibIdibaGicTQFhVX2dRsKVicO1icxhxWVL6wx0g/640?wx_fmt=png&from=appmsg)
è¿™é‡Œæˆªå–äº†ã€Œå¤èŒ—ç‚¹å•å°ç¨‹åºã€åœ¨ä¸é‡‡ç”¨å…¶ä»–ä¼˜åŒ–æ‰‹æ®µç›´æ¥å°†å›¾ç‰‡èµ„æºæ‰“åŒ…åçš„ä»£ç ä¾èµ–åˆ†æå›¾ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­å›¾ç‰‡èµ„æºçš„å°ºå¯¸è¶³è¶³æœ‰ ` 22.07MB `
ï¼Œè¿™ä¸å¾®ä¿¡é™åˆ¶çš„ä¸»åŒ…å¤§å° ` 2MB ` æ•´æ•´ç›¸å·®äº† ` 20MB ` ã€‚

####  è§£å†³æ–¹æ¡ˆ

æˆ‘ä»¬å¯ä»¥å°†è¿™ ` 22.07MB `
çš„å›¾ç‰‡èµ„æºä¸Šä¼ è‡³äº‘ç«¯ã€‚åœ¨å°ç¨‹åºä½¿ç”¨æ—¶ç›´æ¥ä½¿ç”¨ç½‘ç»œè·¯å¾„ã€‚é‚£ä¹ˆæ‰“åŒ…æ—¶è¿™éƒ¨åˆ†èµ„æºå°ºå¯¸å°±ä¸ä¼šè®¡ç®—åœ¨ä¸»åŒ…å°ºå¯¸ä¸­ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•å°†ç°å­˜é¡¹ç›®ä¸­ä½¿ç”¨çš„å›¾ç‰‡èµ„æºè·¯å¾„æ›¿æ¢æˆç½‘ç»œè·¯å¾„ï¼Ÿ

  * â äººå·¥é€ä¸ªæ›¿æ¢ 
    * éœ€è¦ä¿®æ”¹ä½¿ç”¨åˆ°å›¾ç‰‡èµ„æºçš„ä¸šåŠ¡ä»£ç å·¥ä½œé‡å¤§ä¸”æ˜“å‡ºé”™ 
    * ä¸”åç»­å›¾ç‰‡èµ„æºä½¿ç”¨ä¹Ÿå¾ˆç¹çéœ€è¦å¼€å‘ä¸Šä¼ å›¾ç‰‡èµ„æºåä½¿ç”¨ç½‘ç»œåœ°å€ç¼–ç ã€‚ 
  * âœ… ä½¿ç”¨ ` babel ` æ’ä»¶æ‰¹é‡æ›¿æ¢ 
    * ä»…éœ€è¦å®ç°å¯¹åº”çš„ ` babel ` æ’ä»¶é€»è¾‘å¹¶å¼•å…¥ï¼Œæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç  
    * å¼€å‘æ— æ„Ÿï¼Œå›¾ç‰‡èµ„æºçš„ä½¿ç”¨æ–¹å¼ä¸å˜ 

####  æŠ€æœ¯å®ç°

  1. Taro ç¼–è¯‘å¼€å§‹æ—¶ä½¿ç”¨ ` taro ` æ’ä»¶ä¸Šä¼ æœ¬åœ°å›¾ç‰‡èµ„æº 

    
    
    importÂ typeÂ {IPluginContext}Â fromÂ '@tarojs/service'  
    importÂ {PromisePool}Â fromÂ '@supercharge/promise-pool'  
    importÂ pathÂ fromÂ 'path';  
    importÂ fsÂ fromÂ 'fs';  
    importÂ md5Â fromÂ 'md5'  
      
    constÂ cacheFileNameÂ =Â "imgCache.json"  
      
    /**  
    Â *Â é€’å½’æŸ¥æ‰¾æ–‡ä»¶  
    Â */  
    constÂ travelFilesÂ =Â (dir:Â string):Â string[]Â =>Â {  
    Â Â Â Â constÂ filesÂ =Â fs.readdirSync(dir);  
    Â Â Â Â returnÂ files.reduce<string[]>((result,Â file)Â =>Â {  
    Â Â Â Â Â Â Â Â constÂ filePathÂ =Â path.join(dir,Â file);  
    Â Â Â Â Â Â Â Â ifÂ (!fs.statSync(filePath).isDirectory())Â returnÂ [...result,Â filePath];  
    Â Â Â Â Â Â Â Â returnÂ [...result,Â ...travelFiles(filePath)];  
    Â Â Â Â },Â [])  
    }  
      
    /**  
    Â *Â æ–‡ä»¶è·¯å¾„æ ¼å¼åŒ–  
    Â */  
    constÂ filePathFormatÂ =Â (ctx:Â IPluginContext,Â filePath:Â string)Â =>Â {  
    Â Â Â Â returnÂ filePath.replace(ctx.paths.sourcePath,Â "@").replace(/\\/g,Â "/");  
    }  
      
    /**  
    Â *Â ç”Ÿæˆæ–‡ä»¶Â key  
    Â */  
    constÂ generateFileUniqueKeyÂ =Â (filePath:Â string)Â =>Â {  
    Â Â Â Â constÂ {dir,Â base,Â ext}Â =Â path.parse(filePath);  
    Â Â Â Â constÂ bufferÂ =Â fs.readFileSync(`${dir}${path.sep}${base}`);  
    Â Â Â Â returnÂ md5(buffer)  
    }  
      
    constÂ cacheFileÂ =Â path.join(__dirname,Â cacheFileName);  
      
      
    interfaceÂ PluginOptsÂ {  
    Â Â Â Â fileDir:Â string,  
    Â Â Â Â upload:Â (filePath:Â string,Â fileKey:Â string)Â =>Â Promise<string>  
      
    }  
      
    module.exportsÂ =Â (ctx:Â IPluginContext,Â pluginOpts:Â PluginOpts)Â =>Â {  
    Â Â Â Â ctx.onBuildStart(asyncÂ ()Â =>Â {  
    Â Â Â Â Â Â Â Â constÂ {fileDir,Â upload}Â =Â pluginOpts  
    Â Â Â Â Â Â Â Â constÂ fileDirPathÂ =Â `${ctx.paths.sourcePath}/${fileDir}`;  
    Â Â Â Â Â Â Â Â constÂ filePathListÂ =Â travelFiles(fileDirPath);  
      
    Â Â Â Â Â Â Â Â //Â ä¸Šä¼ æ–‡ä»¶  
    Â Â Â Â Â Â Â Â constÂ {results:Â fileUrlList}Â =Â awaitÂ PromisePool.withConcurrency(2)  
    Â Â Â Â Â Â Â Â Â Â Â Â .for(filePathList)  
    Â Â Â Â Â Â Â Â Â Â Â Â .process(asyncÂ (filePath)Â =>Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â constÂ fileUrlÂ =Â awaitÂ upload(filePath,Â generateFileUniqueKey(filePath))  
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ {filePath,Â fileUrl}  
    Â Â Â Â Â Â Â Â Â Â Â Â })  
      
    Â Â Â Â Â Â Â Â //Â ç”Ÿæˆæ–‡ä»¶ç¼“å­˜æ•°æ®  
    Â Â Â Â Â Â Â Â constÂ fileUrlMapÂ =Â fileUrlList.reduce((result,Â item)Â =>Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â constÂ tempKeyÂ =Â filePathFormat(ctx,Â item.filePath)  
    Â Â Â Â Â Â Â Â Â Â Â Â returnÂ {...result,Â [tempKey]:Â item.fileUrl}  
    Â Â Â Â Â Â Â Â },Â {})  
      
    Â Â Â Â Â Â Â Â fs.writeFileSync(cacheFile,Â JSON.stringify(fileUrlMap));  
    Â Â Â Â })  
    }  
      
    

  2. ä½¿ç”¨ ` babel ` æ’ä»¶æ›¿æ¢ ` ts ` æˆ– ` js ` ä¸­å¯¼å…¥çš„å›¾ç‰‡ 

    
    
    importÂ typeÂ {NodePath,Â PluginItem,Â PluginPass}Â fromÂ '@babel/core'  
    importÂ typeÂ {ImportDeclaration,Â Statement}Â fromÂ "@babel/types";  
    importÂ templateÂ fromÂ '@babel/template'  
    importÂ pathÂ fromÂ "path";  
    importÂ fsÂ fromÂ "fs";  
      
    constÂ cacheFileNameÂ =Â "imgCache.json"  
      
    constÂ getCacheDataÂ =Â (filePath:Â string):Â Record<string,Â string>Â =>Â {  
    Â Â Â Â tryÂ {  
    Â Â Â Â Â Â Â Â fs.accessSync(filePath);  
    Â Â Â Â Â Â Â Â returnÂ JSON.parse(fs.readFileSync(filePath).toString());  
    Â Â Â Â }Â catchÂ (error)Â {  
    Â Â Â Â Â Â Â Â returnÂ {}  
    Â Â Â Â }  
      
    }  
      
      
    module.exportsÂ =Â ():Â PluginItemÂ =>Â {  
      
    Â Â Â Â constÂ cacheMapÂ =Â getCacheData(path.join(__dirname,Â cacheFileName));  
      
    Â Â Â Â returnÂ {  
    Â Â Â Â Â Â Â Â visitor:Â {  
    Â Â Â Â Â Â Â Â Â Â Â Â ImportDeclaration(importDeclarationAstPath:Â NodePath<ImportDeclaration>,Â state:Â PluginPass)Â {  
      
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (state.file.opts.filename?.includes("node_modules"))Â return;  
      
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â constÂ {node}Â =Â importDeclarationAstPath;  
      
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â constÂ {value}Â =Â node.source;  
      
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â constÂ fileUrlÂ =Â cacheMap[value]  
      
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (!fileUrl)Â return;  
      
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â constÂ [specifier]Â =Â node.specifiers  
      
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â constÂ assignExpressionÂ =Â template.ast(`constÂ ${specifier.local.name}Â =Â '${fileUrl}';`);  
      
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â importDeclarationAstPath.replaceWith(assignExpressionÂ asÂ Statement);  
    Â Â Â Â Â Â Â Â Â Â Â Â }  
    Â Â Â Â Â Â Â Â }  
    Â Â Â Â }  
    }  
      
    

  3. ä½¿ç”¨ ` postcss ` æ’ä»¶æ›¿æ¢æ ·å¼æ–‡ä»¶ä¸­å¯¼å…¥çš„å›¾ç‰‡ 

    
    
    importÂ {AcceptedPlugin}Â fromÂ "postcss";  
    importÂ pathÂ fromÂ "path";  
    importÂ fsÂ fromÂ "fs";  
      
    constÂ cacheFileNameÂ =Â "imgCache.json"  
      
    constÂ getCacheDataÂ =Â (filePath:Â string):Â Record<string,Â string>Â =>Â {  
    Â Â Â Â tryÂ {  
    Â Â Â Â Â Â Â Â fs.accessSync(filePath);  
    Â Â Â Â Â Â Â Â returnÂ JSON.parse(fs.readFileSync(filePath).toString());  
    Â Â Â Â }Â catchÂ (error)Â {  
    Â Â Â Â Â Â Â Â returnÂ {}  
    Â Â Â Â }  
      
    }  
      
      
    constÂ urlRegexpÂ =Â /url\(['"]([^'"]*)['"]\)/  
      
      
    constÂ filePathFormatÂ =Â (filePath:Â string)Â =>Â filePath.replace('~@',Â '@')  
      
      
    module.exportsÂ =Â ():Â AcceptedPluginÂ =>Â {  
      
    Â Â Â Â constÂ cacheMapÂ =Â getCacheData(path.join(__dirname,Â cacheFileName));  
      
    Â Â Â Â returnÂ {  
    Â Â Â Â Â Â Â Â postcssPlugin:Â 'auto-replace-assets-url',  
      
    Â Â Â Â Â Â Â Â Declaration(decl)Â {  
      
    Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (!urlRegexp.test(decl.value))Â return  
      
    Â Â Â Â Â Â Â Â Â Â Â Â letÂ [_,Â filePath]Â =Â decl.value.match(urlRegexp)!;  
      
    Â Â Â Â Â Â Â Â Â Â Â Â filePathÂ =Â filePathFormat(filePath)  
      
    Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (!cacheMap[filePath])Â return;  
      
    Â Â Â Â Â Â Â Â Â Â Â Â decl.valueÂ =Â `url(${cacheMap[filePath]})`  
      
    Â Â Â Â Â Â Â Â }  
    Â Â Â Â }  
    }  
      
    

##  æ€»ç»“

è¿™é‡Œä»‹ç»äº†é¡µé¢åˆ†åŒ…ã€å…¬å…±æ¨¡å—åˆ†åŒ…å’Œå›¾ç‰‡èµ„æºä¼˜åŒ–çš„æ–¹å¼ä¼˜åŒ–å°ç¨‹åºåŒ…ä½“ç§¯ã€‚æˆ‘ä»¬è¿˜å¯ä»¥å…±åŒæ¢è®¨å…¶ä»–ä¼˜åŒ–ç­–ç•¥å¦‚ï¼šTSæšä¸¾ç¼–è¯‘ä¼˜åŒ–ã€å°ç¨‹åºåˆ†åŒ…å¼‚æ­¥åŒ–ã€æå–å…¬å…±æ ·å¼ã€åŸå­åŒ–æ ·å¼ç»„ä»¶ç­‰ã€‚

##  æœ€å

ğŸ“š å°èŒ—æ–‡ç« æ¨èï¼š

  * [ JSPDF + html2canvas A4åˆ†é¡µæˆªæ–­ ](http://mp.weixin.qq.com/s?__biz=Mzg4OTkwMTY3Mg==&mid=2247485180&idx=1&sn=ea64ad64b9d0d1c2b3dbd08f59728ea1&chksm=cfe581fbf89208edc23bc7fe431b8196177a1444fb4a028f214d137ac3b6e4b9b36f05e785a4&scene=21#wechat_redirect)
  * [ Formily JSON Schema æ¸²æŸ“æµç¨‹åŠæ¡ˆä¾‹æµ…æ ](http://mp.weixin.qq.com/s?__biz=Mzg4OTkwMTY3Mg==&mid=2247485145&idx=1&sn=092946f0f6a3b4a2980d2437eff14ffb&chksm=cfe581def89208c836cb55093142f4ebfac19d116ad8328030c260bd81b0cce5c75eaf8389ed&scene=21#wechat_redirect)
  * [ å¤èŒ—æ˜¯å¦‚ä½•åšå‰ç«¯æ•°æ®ä¸­å¿ƒçš„ ](http://mp.weixin.qq.com/s?__biz=Mzg4OTkwMTY3Mg==&mid=2247485119&idx=1&sn=359c8963c2f89ebfc175a76d1f54faf2&chksm=cfe581b8f89208ae90b04d2b6dd316841ffe7f1ab6389e7186a6974efb9e0e3edc3fb780b53a&scene=21#wechat_redirect)

å…³æ³¨å…¬ä¼—å·ã€Œ  Goodmeå‰ç«¯å›¢é˜Ÿ  ã€ï¼Œè·å–æ›´å¤šå¹²è´§å®è·µï¼Œæ¬¢è¿äº¤æµåˆ†äº«~

  

  

é¢„è§ˆæ—¶æ ‡ç­¾ä¸å¯ç‚¹

å¾®ä¿¡æ‰«ä¸€æ‰«  
å…³æ³¨è¯¥å…¬ä¼—å·





****



****



Ã—  åˆ†æ

  æ”¶è—

